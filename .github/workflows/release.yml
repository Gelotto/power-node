name: Release

on:
  push:
    branches:
      - main
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/release.yml'

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - run: go test ./... -race -coverprofile=coverage.out
      - run: go tool cover -func=coverage.out | tail -1

  build-and-release:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install cross-compiler
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Generate version
        id: version
        run: |
          COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION="v0.3.${COMMIT_COUNT}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Build binaries
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Linux x86_64 (CGO required for go-nvml, uses dlopen at runtime)
          GOOS=linux GOARCH=amd64 \
            go build -ldflags="-s -w -X main.Version=$VERSION -extldflags=-Wl,-z,lazy" \
            -o power-node-linux-x86_64 ./cmd/power-node

          # Linux arm64 (cross-compile with arm64 gcc)
          GOOS=linux GOARCH=arm64 CC=aarch64-linux-gnu-gcc CGO_ENABLED=1 \
            go build -ldflags="-s -w -X main.Version=$VERSION -extldflags=-Wl,-z,lazy" \
            -o power-node-linux-arm64 ./cmd/power-node

      - name: Create/Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          body: |
            Auto-release from commit ${{ github.sha }}

            ## Changes
            ${{ github.event.head_commit.message }}
          files: |
            power-node-linux-x86_64
            power-node-linux-arm64
          prerelease: false
          make_latest: true
